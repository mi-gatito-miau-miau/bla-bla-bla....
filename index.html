<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Epic RPG Ultimate</title>
<style>
body{margin:0;overflow:hidden;background:black;font-family:monospace}
#hud{position:fixed;top:10px;left:10px;color:white;z-index:10}
#inventory,#questlog{
  position:fixed;top:50%;left:50%;
  transform:translate(-50%,-50%);
  background:#111;padding:10px;border:1px solid #555;
  display:none;color:white
}
.slot{width:40px;height:40px;border:1px solid #777;display:inline-block;margin:4px;text-align:center}
#minimap{
  position:fixed;right:10px;bottom:10px;
  width:150px;height:150px;
  background:#222;border:1px solid #555
}
</style>
</head>
<body>

<div id="hud">
â¤ï¸ <span id="hp"></span>
ğŸ’° <span id="gold"></span>
ğŸ—ï¸ <span id="keys"></span>
ğŸŒ™ <span id="time"></span>
ğŸ“œ <span id="quest"></span>
</div>

<div id="inventory">
<h3>ğŸ’ Inventory (I)</h3>
<div id="slots"></div>
</div>

<div id="questlog">
<h3>ğŸ­ Quest</h3>
<div id="questText"></div>
</div>

<canvas id="minimap"></canvas>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
/* ================= CORE ================= */
const scene=new THREE.Scene();
scene.fog=new THREE.Fog(0x88aacc,30,400);
const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,1000);
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.shadowMap.enabled=true;
document.body.appendChild(renderer.domElement);

/* ================= LIGHT + DAY/NIGHT ================= */
let timeOfDay=0;
const sun=new THREE.DirectionalLight(0xffffff,1.2);
sun.position.set(100,200,100);
sun.castShadow=true;
scene.add(sun);
const ambient=new THREE.AmbientLight(0x404040,0.5);
scene.add(ambient);

/* ================= WORLD ================= */
const ground=new THREE.Mesh(
  new THREE.PlaneGeometry(800,800).rotateX(-Math.PI/2),
  new THREE.MeshStandardMaterial({color:0x3e8e41})
);
ground.receiveShadow=true;
scene.add(ground);

/* ================= PLAYER ================= */
const player=new THREE.Object3D();
scene.add(player);
player.position.set(0,2,0);

let stats={
  hp:100,maxHP:100,gold:0,keys:0,damage:15,speed:0.15
};

const body=new THREE.Mesh(
  new THREE.CapsuleGeometry(0.5,1.2),
  new THREE.MeshStandardMaterial({color:0x3366ff})
);
body.castShadow=true;
player.add(body);

/* ================= WEAPON ================= */
const sword=new THREE.Mesh(
  new THREE.BoxGeometry(0.1,1.1,0.15),
  new THREE.MeshStandardMaterial({color:0xdddddd,metalness:0.8})
);
sword.position.set(0.7,0.6,0);
player.add(sword);

/* ================= CASTLE + DOOR ================= */
const castle=new THREE.Mesh(
  new THREE.BoxGeometry(10,6,10),
  new THREE.MeshStandardMaterial({color:0x777777})
);
castle.position.set(30,3,-30);
scene.add(castle);

const door=new THREE.Mesh(
  new THREE.BoxGeometry(2,3,0.5),
  new THREE.MeshStandardMaterial({color:0x552200})
);
door.position.set(30,1.5,-25);
door.locked=true;
scene.add(door);

/* ================= NPC QUEST ================= */
const npc=new THREE.Mesh(
  new THREE.BoxGeometry(1,2,1),
  new THREE.MeshStandardMaterial({color:0xffff00})
);
npc.position.set(-10,1,-10);
scene.add(npc);

let quest={active:true,done:false,text:"Find a key and open the castle door"};

/* ================= ENEMY + BOSS ================= */
let enemies=[];
function spawnEnemy(boss=false){
  const e=new THREE.Mesh(
    new THREE.BoxGeometry(boss?3:1, boss?4:1.5, boss?3:1),
    new THREE.MeshStandardMaterial({color:boss?0x550000:0xaa0000})
  );
  e.hp=boss?300:40;
  e.boss=boss;
  e.cooldown=0;
  e.position.set((Math.random()-0.5)*200,1,(Math.random()-0.5)*200);
  scene.add(e);
  enemies.push(e);
}
spawnEnemy();
spawnEnemy(true);

/* ================= INVENTORY ================= */
let inventory=["ğŸ—ï¸","ğŸ§ª"];
function updateInventory(){
  const s=document.getElementById("slots");
  s.innerHTML="";
  inventory.forEach(i=>s.innerHTML+=`<div class="slot">${i}</div>`);
}
updateInventory();

/* ================= SOUND ================= */
const bgm=new Audio("https://cdn.pixabay.com/audio/2022/03/15/audio_8bcd6b28c2.mp3");
bgm.loop=true; bgm.volume=0.3; bgm.play();

/* ================= SAVE / LOAD ================= */
function saveGame(){
  localStorage.setItem("save",JSON.stringify({stats,inventory,quest}));
}
function loadGame(){
  const d=JSON.parse(localStorage.getItem("save"));
  if(!d)return;
  stats=d.stats; inventory=d.inventory; quest=d.quest;
  updateInventory();
}

/* ================= INPUT ================= */
const keys={};
addEventListener("keydown",e=>{
  keys[e.key.toLowerCase()]=true;
  if(e.key==="i")toggle("inventory");
  if(e.key==="s")saveGame();
  if(e.key==="l")loadGame();
  if(e.key==="e")interact();
});
addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

/* ================= INTERACT ================= */
function interact(){
  if(player.position.distanceTo(door.position)<3 && door.locked && stats.keys>0){
    door.locked=false;
    scene.remove(door);
    stats.keys--;
    quest.done=true;
  }
  if(player.position.distanceTo(npc.position)<3){
    document.getElementById("questlog").style.display="block";
    document.getElementById("questText").textContent=quest.text;
  }
}
function toggle(id){
  const e=document.getElementById(id);
  e.style.display=e.style.display==="block"?"none":"block";
}

/* ================= MINIMAP ================= */
const map=document.getElementById("minimap");
const mctx=map.getContext("2d");

/* ================= GAME LOOP ================= */
function loop(){
  requestAnimationFrame(loop);

  if(keys.w)player.position.z-=stats.speed;
  if(keys.s)player.position.z+=stats.speed;
  if(keys.a)player.position.x-=stats.speed;
  if(keys.d)player.position.x+=stats.speed;

  enemies.forEach(e=>{
    if(!e.parent)return;
    e.lookAt(player.position);
    e.translateZ(0.02);
    if(e.boss && e.cooldown<=0){
      e.cooldown=200;
      stats.hp-=10; // special attack
    }
    e.cooldown--;
  });

  // DAY/NIGHT
  timeOfDay+=0.002;
  sun.intensity=0.3+Math.sin(timeOfDay)*0.7;
  document.getElementById("time").textContent=sun.intensity<0.5?"Night":"Day";

  // HUD
  document.getElementById("hp").textContent=stats.hp;
  document.getElementById("gold").textContent=stats.gold;
  document.getElementById("keys").textContent=stats.keys;
  document.getElementById("quest").textContent=quest.done?"Done":"Active";

  // MINIMAP
  mctx.fillStyle="#000";mctx.fillRect(0,0,150,150);
  mctx.fillStyle="blue";
  mctx.fillRect(75,75,5,5);

  camera.position.lerp(
    new THREE.Vector3(player.position.x,player.position.y+8,player.position.z+14),0.08
  );
  camera.lookAt(player.position);

  renderer.render(scene,camera);
}
loop();

addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
